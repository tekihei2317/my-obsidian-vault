## Dockerが遅い問題を解決したい

[Docker開発環境が遅い問題を解決する│hoge](https://hi97.hamazo.tv/e8859609.html)

この記事によると、レスポンスが3s→0.2s~0.3sくらいに高速化されたらしいので、試してみる。

### 現状

画面レスポンスが返ってくるまでに、平均2.0sかかっている

### 考えられる問題点

- MySQLのデータをバインドマウントしている
- composerのパッケージ（vendor/）をバインドマウントしている
- node_modules/をバインドマウントしている

それぞれのサイズは、206M、91M、224Mだった。

### MySQLのデータのバインドマウントをやめる

とりあえずバインドマウントをやめて名前付きボリュームを使うようにする。

平均1.92sになった。Inertiaを使っているページのほうが使っていないページより早い感じがします。

### node_modulesのバインドマウントをやめる

フロントエンドを別ディレクトリに分けたい気分です。Laravel mixをつかって、JSはホストの8080番ポートから読み込んでいるので分けられる気がします。

`mix`ヘルパがどういう挙動をするかが問題。`config/app.php`の`mix_url`でオリジンを変えられるみたいなので、大丈夫そうな気がする（デフォルトがlocalhost:8080なのだと思う）。

参考: https://readouble.com/laravel/6.x/ja/mix.html

名前付きボリュームを書くと、ホスト側とコンテナ側で同期されなくなった（ホスト側にはインストールされているが、コンテナ側のnode_modulesは空ディレクトリだった）。なぜ空のディレクトリが出来ているのだろうか？

結果: 平均1.83s (1.76+1.49+2.22+1.98+1.74)。正直ほとんど変わっていない。

### Webサーバー修正

今見ると、LaravelのデータがアプリケーションサーバーだけでなくWebサーバーにも共有されていた。ここでもnode_modulesが共有されていそう。これ`public`ディレクトリだけ共有すれば良いのでは？

`public`ディレクトリだけ共有するとなんか遅くなった（なんだこれ...）。測定するときほぼ変わらなかった

結果: 平均1.80s (1.76+2.14+1.87+1.70+1.52)

### vendor修正

一番小さいファイルなので意味ないのでは...?と思っていたが、そんなことはなかった。

結果: 平均0.48s (0.52+0.44+0.50+0.47+0.47)

どうやらここがボトルネックになっていたらしい（つまり、ホスト→コンテナは十分に早いが、コンテナ→ホストが遅い？）。最終的にはホスト内とコンテナ内のディレクトリ容量は以下のようになった。

```text
# コンテナ（vendorを入れている）
bash-5.1# du -h -d 1
168.0K  ./database
32.0K   ./bootstrap
312.0K  ./app
76.0K   ./config
448.0K  ./resources
4.0K    ./node_modules
44.0K   ./tests
19.2M   ./storage
7.3M    ./public
100.0K  ./packages
24.0K   ./routes
96.8M   ./vendor
125.7M  .

# ホスト（node_modulesを入れている、あれvendor入ってるんだが...?）
> du -h -d 1
168K    ./database
 32K    ./bootstrap
312K    ./app
 76K    ./config
448K    ./resources
224M    ./node_modules
 44K    ./tests
 19M    ./storage
7.3M    ./public
100K    ./packages
 24K    ./routes
 90M    ./vendor
343M    .
```

ホスト側でもパッケージをインストールしないとIDEの補完が効かなくなる問題があるらしい。ちょっとマウントについて調べる必要があるなぁ。

あとdevcontainerとか、git submoduleについても調べたい（テンプレートを作りたいため）。

## 属性情報のCRUD処理RTA

14:13 開始

- マイグレーションの作成が終わらなくて草
- 一覧の作成
  - Eloquent Modelのallとgetの違い
- make:resourceも停止してしまっている
  - セッションを抜けた
  - プロセスをkillできなくなってしまった（-9つけてもダメ
- コンテナ落としたら入れなくなってしまった（草）

14:39 なくなくdocker daemonを再起動

- IDで削除するにはEloquentの`destroy`を使えばOK？
- Modelに対して直接Deleteでも良いか

14:55 一覧と削除の実装が完了、登録の実装開始

15:12 登録の実装完了

- ルートモデルバインディングを理解したい
- 更新のリクエストで403が出る
  - フォームリクエストで許可していなかった

15:29 実装完了

- 一覧のページネーションの実装をどうするか（未実装）
