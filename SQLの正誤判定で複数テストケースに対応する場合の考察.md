# SQLの正誤判定で複数テストケースに対応する場合の考察

## テストケースは複数必要

以下の2点に注意します。

- 1つの問題に複数のテーブルを使うことがある（JOINを使う問題）
- クエリの正誤判定には、複数のテストケースが必要

なぜテストケースが複数必要かというと、間違った回答を正解だと判定しないようにするためです。

例えば、商品を表す`products`テーブルと、購入履歴を表す`purchases`テーブルから、売上の合計を求める問題を考えます。クエリはこんな感じになると思います。

```sql
-- 商品と購入履歴をJOINして、価格×個数の合計を求める
select
  sum(products.price * purchases.count)
from
  purchases
  inner join products
  on purchases.product_id = products.id
;
```

例えばこの問題の答えが`134500`だとすると、テストケースが1つしかなければ以下のクエリも正解になります。

```sql
select 134500;
```

よって、テストケースは複数必要です。つまり、複数の`products`テーブルと`purchases`テーブルを用意する必要があります。

## テーブルをどのように配置するか（私の案）

問題は、これらの複数のテーブルをどのように配置するかです。MySQLの場合、1つのデータベース（`show databases`で確認できる、テーブルの1つ上のくくりのことです）の中に同じ名前のテーブルは複数作れないので、テストケースの数だけデータベースを作る必要があります。[^1]

例えば以下のようにします。まず、データベース名を`<問題ID>_<テストケースID>`にします。判定前に`use <問題ID>_<テストケースID>`を実行してから、ユーザーのクエリを実行して回答と比較します。

```text
MySQL
├── 1_1
│   ├── products
│   └── purchases
├── 1_2
│   ├── products
│   └── purchases
├── 1_3
│   ├── products
│   └── purchases
└── sql_service_development # システム用のデータベース
```

この方法の懸念点には以下があります。

- データベースの数が増える
	- `問題数`×`テストケース数`の数だけデータベースが必要になります
- データを書き換えることはできないので、`SELECT文`の判定しかできません

## まとめ

- テストケースは複数必要
- （問題番号, テストケース番号）のペアをデータベース名使って、その中に判定に使うテーブルを入れる

考慮するべきことや他の案があれば教えていただきたいです。（MySQL以外のDBMSの場合はどうなのか、RDSではデータベースをたくさん作れない、Dockerを使えばいい感じにできる、など）

[^1]: ユーザーのクエリを書き換えない場合です。クエリを書き換える場合は、例えばテーブル名にプレフィックスをつければ（`1_products`等）、同じ問題のテストケースを1つのデータベースに入れてまとめることができます。